# Sing-box 依赖管理完善 - v2.4.1

## 更新背景

在 v2.4.0 版本中，用户反馈在使用"批量重新分配端口"功能时遇到 `jq` 未安装的错误。经过分析发现，当前的依赖安装函数 `install_dependencies()` 只包含了基础依赖，但项目实际使用了更多的系统工具和命令。

## 问题分析

### 原有依赖列表
- curl
- wget 
- unzip
- openssl
- qrencode
- jq

### 项目实际使用的工具
通过代码分析发现，项目中使用了以下工具：

**核心工具**:
- `curl` - API 请求和文件下载
- `wget` - 备用下载工具
- `jq` - JSON 解析和处理
- `openssl` - 加密和证书操作
- `tar` - 压缩包解压
- `unzip` - ZIP 文件解压
- `gzip` - 压缩文件处理

**系统工具**:
- `uuidgen` / `uuid-runtime` - UUID 生成
- `base64` - Base64 编码解码
- `netstat` / `net-tools` - 网络状态查看
- `pgrep` / `procps` - 进程管理
- `systemctl` / `systemd` - 服务管理
- `qrencode` - 二维码生成

**基础工具**:
- `grep` - 文本搜索
- `awk` / `gawk` - 文本处理
- `sed` - 流编辑器
- `cut` - 文本切割
- `date` - 日期时间
- `free` - 内存信息
- `df` - 磁盘信息

## 解决方案

### 1. 完善依赖列表

**Ubuntu/Debian 系统**:
```bash
apt install -y \
    curl wget unzip tar gzip openssl qrencode jq \
    uuid-runtime coreutils net-tools procps systemd \
    grep gawk sed util-linux ca-certificates
```

**CentOS/RHEL/Fedora 系统**:
```bash
# DNF (Fedora/新版 CentOS)
dnf install -y \
    curl wget unzip tar gzip openssl qrencode jq \
    util-linux coreutils net-tools procps-ng systemd \
    grep gawk sed ca-certificates

# YUM (旧版 CentOS/RHEL)
yum install -y \
    curl wget unzip tar gzip openssl qrencode jq \
    util-linux coreutils net-tools procps systemd \
    grep gawk sed ca-certificates
```

### 2. 增强系统兼容性

- **未知系统处理**: 添加对 Arch Linux (pacman) 的支持
- **通用包管理器检测**: 自动检测并使用可用的包管理器
- **友好错误提示**: 当无法自动安装时，提供手动安装指导

### 3. 依赖验证机制

添加安装后验证功能：
- 检查关键依赖是否安装成功
- 列出缺失的依赖
- 安装失败时提供明确的错误信息

## 技术实现

### 依赖分类管理

```bash
# 关键依赖（必须安装）
required_deps=("curl" "wget" "jq" "openssl" "tar" "unzip")

# 验证安装状态
for dep in "${required_deps[@]}"; do
    if ! command -v "$dep" >/dev/null 2>&1; then
        missing_deps+=("$dep")
    fi
done
```

### 包管理器自动检测

```bash
if command -v apt >/dev/null 2>&1; then
    apt update && apt install -y ...
elif command -v yum >/dev/null 2>&1; then
    yum install -y ...
elif command -v pacman >/dev/null 2>&1; then
    pacman -Sy --noconfirm ...
else
    echo "请手动安装依赖"
fi
```

## 更新内容

### 文件修改
- **singbox-install.sh** - 完善 `install_dependencies()` 函数

### 新增功能
1. **完整依赖列表** - 包含项目使用的所有工具
2. **系统兼容性** - 支持更多 Linux 发行版
3. **依赖验证** - 安装后自动验证
4. **错误处理** - 友好的错误提示和解决方案
5. **进度提示** - 清晰的安装进度显示

### 依赖包说明

| 包名 | 用途 | 必需性 |
|------|------|--------|
| curl | API 请求、文件下载 | 必需 |
| wget | 备用下载工具 | 必需 |
| jq | JSON 解析处理 | 必需 |
| openssl | 加密、证书操作 | 必需 |
| tar | 压缩包解压 | 必需 |
| unzip | ZIP 文件解压 | 必需 |
| uuid-runtime | UUID 生成 | 重要 |
| net-tools | 网络状态查看 | 重要 |
| procps | 进程管理 | 重要 |
| qrencode | 二维码生成 | 功能性 |
| systemd | 服务管理 | 系统级 |
| coreutils | 基础工具集 | 系统级 |

## 兼容性说明

### 支持的系统
- ✅ Ubuntu 18.04+
- ✅ Debian 9+
- ✅ CentOS 7+
- ✅ RHEL 7+
- ✅ Fedora 30+
- ✅ Arch Linux
- ⚠️ 其他 Linux 发行版（尝试自动检测）

### 包管理器支持
- ✅ APT (Ubuntu/Debian)
- ✅ YUM (CentOS 7/RHEL 7)
- ✅ DNF (Fedora/CentOS 8+)
- ✅ Pacman (Arch Linux)

## 测试验证

### 测试场景
1. **全新系统安装** - 验证所有依赖正确安装
2. **部分依赖缺失** - 验证增量安装功能
3. **网络环境限制** - 验证错误处理机制
4. **不同发行版** - 验证跨平台兼容性

### 验证命令
```bash
# 检查关键依赖
for cmd in curl wget jq openssl tar unzip; do
    command -v $cmd && echo "$cmd: ✅" || echo "$cmd: ❌"
done

# 测试功能
./singbox-install.sh --install
```

## 性能优化

### 安装优化
- **并行安装**: 使用包管理器的并行安装功能
- **缓存利用**: 避免重复更新包列表
- **最小化安装**: 只安装必要的依赖包

### 错误恢复
- **失败重试**: 网络问题时自动重试
- **部分成功**: 已安装的依赖不重复安装
- **清理机制**: 安装失败时清理临时文件

## 后续优化建议

1. **依赖版本管理** - 指定最低版本要求
2. **离线安装支持** - 提供离线依赖包
3. **容器化部署** - 提供 Docker 镜像
4. **自动更新机制** - 定期检查依赖更新

## 版本信息

- **版本号**: v2.4.1
- **发布日期**: 2024年12月
- **更新类型**: 功能增强
- **兼容性**: 向后兼容
- **测试状态**: 已测试

---

**注意**: 本次更新主要解决了用户在使用高级功能时遇到的依赖缺失问题，提升了脚本的稳定性和用户体验。建议所有用户更新到此版本。