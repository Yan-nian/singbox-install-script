# 配置记忆功能修复 - v2.4.3

## 问题描述

当前脚本设计存在问题：
- 脚本运行完退出后，再次运行会显示没有配置协议
- 无法像程序一样记忆已安装的配置
- 每次启动都重新初始化变量，不读取现有配置

## 问题分析

### 当前流程问题
1. **变量初始化问题**：`init_config_vars()` 每次都重置所有变量为空
2. **配置加载时机**：只在特定条件下调用 `load_config()`
3. **状态持久化缺失**：没有在启动时自动检测和加载现有配置

### 根本原因
- `singbox-install.sh` 主函数中，即使检测到已安装，也没有强制加载配置
- `config_manager.sh` 中的 `load_config()` 函数存在但调用不充分
- 缺少启动时的配置状态检测机制

## 解决方案

### 方案 1：启动时自动加载配置（推荐）
**优点**：
- 实现真正的配置记忆功能
- 用户体验最佳，符合程序化需求
- 修改量最小，风险最低

**实现步骤**：
1. 修改主函数，在显示菜单前强制加载配置
2. 优化 `load_config()` 函数的错误处理
3. 添加配置状态显示功能

### 方案 2：配置文件状态缓存
**优点**：
- 性能更好，避免重复解析JSON
- 可以缓存更多状态信息

**缺点**：
- 实现复杂度较高
- 需要处理缓存同步问题

## 实施计划

### 第一阶段：核心修复
1. **修改主函数逻辑**
   - 在 `show_main_menu` 前调用 `load_config`
   - 添加配置加载状态提示

2. **优化配置加载函数**
   - 改进错误处理，避免因配置文件问题导致脚本退出
   - 添加配置完整性检查

3. **增强主菜单显示**
   - 显示当前已配置的协议数量
   - 显示配置状态概览

### 第二阶段：用户体验优化
1. **智能配置检测**
   - 自动识别已配置但未在变量中的协议
   - 提供配置修复建议

2. **配置状态指示器**
   - 在菜单中显示各协议的配置状态
   - 提供快速重新配置选项

## 技术实现

### 修改文件清单
1. `singbox-install.sh` - 主函数逻辑
2. `lib/config_manager.sh` - 配置加载优化
3. `lib/menu.sh` - 菜单显示增强

### 关键代码修改

#### 1. 主函数修改
```bash
# 在 main() 函数中，show_main_menu 前添加
if [[ -f "$CONFIG_FILE" ]]; then
    echo -e "${CYAN}正在加载现有配置...${NC}"
    load_config || log_warn "配置加载失败，将使用默认设置"
else
    log_info "未找到配置文件，将创建新配置"
fi
```

#### 2. 配置加载优化
```bash
# 在 load_config() 函数中添加容错机制
load_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        log_info "配置文件不存在，跳过加载"
        return 0  # 改为返回成功，避免阻断流程
    fi
    
    # ... 现有逻辑 ...
    
    # 添加配置摘要
    local configured_count=0
    [[ -n "$VLESS_PORT" ]] && ((configured_count++))
    [[ -n "$VMESS_PORT" ]] && ((configured_count++))
    [[ -n "$HY2_PORT" ]] && ((configured_count++))
    
    if [[ $configured_count -gt 0 ]]; then
        log_success "已加载 $configured_count 个协议配置"
    else
        log_info "未找到已配置的协议"
    fi
    
    return 0
}
```

#### 3. 主菜单增强
```bash
# 在主菜单中添加配置状态显示
show_main_menu() {
    # ... 现有代码 ...
    
    # 显示配置状态
    echo -e "${GREEN}配置状态:${NC}"
    local status_line=""
    [[ -n "$VLESS_PORT" ]] && status_line+="VLESS(${VLESS_PORT}) "
    [[ -n "$VMESS_PORT" ]] && status_line+="VMess(${VMESS_PORT}) "
    [[ -n "$HY2_PORT" ]] && status_line+="Hysteria2(${HY2_PORT}) "
    
    if [[ -n "$status_line" ]]; then
        echo -e "${GREEN}已配置:${NC} $status_line"
    else
        echo -e "${YELLOW}未配置任何协议${NC}"
    fi
    
    # ... 其余菜单代码 ...
}
```

## 测试计划

### 测试场景
1. **全新安装测试**
   - 验证首次安装后的配置流程
   - 确认配置保存和加载正常

2. **重启记忆测试**
   - 配置协议后退出脚本
   - 重新运行脚本验证配置记忆

3. **多协议测试**
   - 配置多个协议
   - 验证所有协议信息正确加载

4. **异常情况测试**
   - 配置文件损坏时的处理
   - 部分配置缺失时的处理

## 预期效果

修复后的脚本将具备：
1. **真正的配置记忆**：重启后自动恢复所有配置状态
2. **智能状态显示**：主菜单直观显示当前配置
3. **容错能力**：配置问题不会导致脚本无法使用
4. **用户友好**：符合程序化使用习惯

## 版本规划

- **v2.4.3**：核心配置记忆功能修复
- **v2.4.4**：用户体验优化和错误处理增强
- **v2.5.0**：配置管理功能全面重构（可选）