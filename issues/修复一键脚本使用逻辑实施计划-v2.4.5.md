# 修复一键脚本使用逻辑实施计划 - v2.4.5

## 实施方案：统一安装状态检查

### 目标
解决 `singbox-install.sh` 重复安装问题，确保安装/更新后使用 `sb` 命令不会再次触发安装流程。

## 详细实施步骤

### 第一步：增强安装状态检查函数

**文件**：`singbox-install.sh`
**位置**：在现有函数之前添加
**功能**：多维度检查 Sing-box 安装状态

```bash
# 检查 Sing-box 安装状态
check_installation_status() {
    local status="not_installed"
    local install_method="unknown"
    local details=""
    
    # 检查二进制文件
    if [[ -f "$SINGBOX_BINARY" ]]; then
        status="installed"
        install_method="binary"
        local version=$($SINGBOX_BINARY version 2>/dev/null | head -1 || echo "未知版本")
        details="二进制文件存在 ($version)"
    fi
    
    # 检查系统服务
    if systemctl list-unit-files 2>/dev/null | grep -q "sing-box.service"; then
        status="installed"
        if [[ "$install_method" == "unknown" ]]; then
            install_method="service"
            details="系统服务已安装"
        else
            install_method="complete"
            details="$details + 系统服务"
        fi
    fi
    
    # 检查配置文件
    if [[ -f "$CONFIG_FILE" ]]; then
        status="installed"
        if [[ "$install_method" == "unknown" ]]; then
            install_method="config"
            details="配置文件存在"
        else
            details="$details + 配置文件"
        fi
    fi
    
    # 检查配置目录
    if [[ -d "$CONFIG_DIR" ]] && [[ $(ls -A "$CONFIG_DIR" 2>/dev/null | wc -l) -gt 0 ]]; then
        status="installed"
        if [[ "$install_method" == "unknown" ]]; then
            install_method="config_dir"
            details="配置目录存在"
        else
            details="$details + 配置目录"
        fi
    fi
    
    echo "$status:$install_method:$details"
}
```

### 第二步：创建安装状态诊断函数

**文件**：`singbox-install.sh`
**位置**：在 `check_installation_status` 函数之后
**功能**：详细显示当前安装状态

```bash
# 诊断安装状态
diagnose_installation() {
    echo -e "${CYAN}=== Sing-box 安装状态诊断 ===${NC}"
    echo
    
    # 检查二进制文件
    if [[ -f "$SINGBOX_BINARY" ]]; then
        local version=$($SINGBOX_BINARY version 2>/dev/null | head -1 || echo "版本获取失败")
        echo -e "${GREEN}[OK]${NC} 二进制文件: $SINGBOX_BINARY"
        echo -e "     版本: $version"
    else
        echo -e "${RED}[NO]${NC} 二进制文件: 未找到"
    fi
    
    # 检查系统服务
    if systemctl list-unit-files 2>/dev/null | grep -q "sing-box.service"; then
        local service_status=$(systemctl is-active sing-box 2>/dev/null || echo "未知")
        local service_enabled=$(systemctl is-enabled sing-box 2>/dev/null || echo "未知")
        echo -e "${GREEN}[OK]${NC} 系统服务: 已安装"
        echo -e "     状态: $service_status | 开机启动: $service_enabled"
    else
        echo -e "${RED}[NO]${NC} 系统服务: 未安装"
    fi
    
    # 检查配置文件
    if [[ -f "$CONFIG_FILE" ]]; then
        local config_size=$(du -h "$CONFIG_FILE" 2>/dev/null | cut -f1 || echo "未知")
        echo -e "${GREEN}[OK]${NC} 配置文件: $CONFIG_FILE"
        echo -e "     大小: $config_size"
    else
        echo -e "${RED}[NO]${NC} 配置文件: 未找到"
    fi
    
    # 检查配置目录
    if [[ -d "$CONFIG_DIR" ]]; then
        local file_count=$(ls -A "$CONFIG_DIR" 2>/dev/null | wc -l)
        echo -e "${GREEN}[OK]${NC} 配置目录: $CONFIG_DIR"
        echo -e "     文件数量: $file_count"
    else
        echo -e "${RED}[NO]${NC} 配置目录: 未找到"
    fi
    
    # 检查快捷命令
    if [[ -L "/usr/local/bin/sb" ]]; then
        local target=$(readlink /usr/local/bin/sb 2>/dev/null || echo "读取失败")
        echo -e "${GREEN}[OK]${NC} 快捷命令: /usr/local/bin/sb"
        echo -e "     指向: $target"
    else
        echo -e "${RED}[NO]${NC} 快捷命令: 未创建"
    fi
    
    # 检查端口占用
    if command -v netstat >/dev/null 2>&1; then
        local listening_ports=$(netstat -tlnp 2>/dev/null | grep sing-box | wc -l)
        if [[ $listening_ports -gt 0 ]]; then
            echo -e "${GREEN}[OK]${NC} 端口监听: $listening_ports 个端口"
        else
            echo -e "${YELLOW}[--]${NC} 端口监听: 无活动端口"
        fi
    fi
    
    echo
}
```

### 第三步：创建智能安装管理菜单

**文件**：`singbox-install.sh`
**位置**：在诊断函数之后
**功能**：根据安装状态提供合适的选项

```bash
# 显示安装管理菜单
show_installation_menu() {
    local install_info="$1"
    local status=$(echo "$install_info" | cut -d: -f1)
    local method=$(echo "$install_info" | cut -d: -f2)
    local details=$(echo "$install_info" | cut -d: -f3)
    
    echo -e "${CYAN}=== Sing-box 管理菜单 ===${NC}"
    echo -e "${GREEN}当前状态:${NC} $details"
    echo
    
    case "$status" in
        "installed")
            echo -e "${GREEN}1.${NC} 显示主菜单（管理配置）"
            echo -e "${GREEN}2.${NC} 重新安装 Sing-box"
            echo -e "${GREEN}3.${NC} 更新 Sing-box 版本"
            echo -e "${GREEN}4.${NC} 显示安装状态诊断"
            echo -e "${GREEN}5.${NC} 卸载 Sing-box"
            echo -e "${GREEN}0.${NC} 退出"
            echo
            
            read -p "请选择 [0-5]: " choice
            
            case "$choice" in
                1)
                    load_existing_config
                    show_main_menu
                    ;;
                2)
                    echo -e "${YELLOW}确认重新安装？这将覆盖现有配置。${NC}"
                    read -p "输入 'yes' 确认: " confirm
                    if [[ "$confirm" == "yes" ]]; then
                        perform_installation
                    else
                        show_installation_menu "$install_info"
                    fi
                    ;;
                3)
                    update_singbox
                    ;;
                4)
                    diagnose_installation
                    read -p "按回车键返回菜单..." 
                    show_installation_menu "$install_info"
                    ;;
                5)
                    uninstall_singbox
                    ;;
                0)
                    exit 0
                    ;;
                *)
                    echo -e "${RED}无效选择${NC}"
                    show_installation_menu "$install_info"
                    ;;
            esac
            ;;
        "not_installed")
            echo -e "${YELLOW}Sing-box 未安装，开始安装流程...${NC}"
            perform_installation
            ;;
    esac
}
```

### 第四步：修改主函数逻辑

**文件**：`singbox-install.sh`
**位置**：替换现有的 `main` 函数
**功能**：智能判断安装状态并选择合适的处理方式

```bash
# 主函数 - 智能版
main() {
    check_root
    show_banner
    detect_system
    create_directories
    load_modules
    
    # 获取安装状态
    local install_info=$(check_installation_status)
    local status=$(echo "$install_info" | cut -d: -f1)
    
    log_debug "安装状态检查结果: $install_info"
    
    # 根据安装状态选择处理方式
    case "$status" in
        "installed")
            echo -e "${GREEN}检测到 Sing-box 已安装${NC}"
            show_installation_menu "$install_info"
            ;;
        "not_installed")
            echo -e "${YELLOW}Sing-box 未安装，开始安装流程...${NC}"
            perform_installation
            ;;
        *)
            echo -e "${RED}安装状态检查异常: $install_info${NC}"
            diagnose_installation
            exit 1
            ;;
    esac
}
```

### 第五步：添加更新和卸载函数

**文件**：`singbox-install.sh`
**位置**：在主函数之前
**功能**：提供更新和卸载功能

```bash
# 更新 Sing-box
update_singbox() {
    echo -e "${CYAN}=== 更新 Sing-box ===${NC}"
    
    # 停止服务
    if systemctl is-active sing-box >/dev/null 2>&1; then
        echo -e "${YELLOW}停止 Sing-box 服务...${NC}"
        systemctl stop sing-box
    fi
    
    # 备份配置
    if [[ -f "$CONFIG_FILE" ]]; then
        local backup_file="${CONFIG_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
        cp "$CONFIG_FILE" "$backup_file"
        echo -e "${GREEN}配置已备份到: $backup_file${NC}"
    fi
    
    # 重新安装二进制文件
    install_singbox
    
    # 重启服务
    if systemctl is-enabled sing-box >/dev/null 2>&1; then
        echo -e "${YELLOW}重启 Sing-box 服务...${NC}"
        systemctl start sing-box
        
        if systemctl is-active sing-box >/dev/null 2>&1; then
            echo -e "${GREEN}Sing-box 更新完成并已重启${NC}"
        else
            echo -e "${RED}Sing-box 更新完成但启动失败，请检查配置${NC}"
        fi
    else
        echo -e "${GREEN}Sing-box 更新完成${NC}"
    fi
}

# 卸载 Sing-box
uninstall_singbox() {
    echo -e "${CYAN}=== 卸载 Sing-box ===${NC}"
    echo -e "${RED}警告：这将完全删除 Sing-box 及其所有配置！${NC}"
    read -p "输入 'UNINSTALL' 确认卸载: " confirm
    
    if [[ "$confirm" != "UNINSTALL" ]]; then
        echo -e "${YELLOW}卸载已取消${NC}"
        return
    fi
    
    # 停止并禁用服务
    if systemctl is-active sing-box >/dev/null 2>&1; then
        systemctl stop sing-box
    fi
    
    if systemctl is-enabled sing-box >/dev/null 2>&1; then
        systemctl disable sing-box
    fi
    
    # 删除服务文件
    if [[ -f "/etc/systemd/system/sing-box.service" ]]; then
        rm -f /etc/systemd/system/sing-box.service
        systemctl daemon-reload
    fi
    
    # 删除二进制文件
    if [[ -f "$SINGBOX_BINARY" ]]; then
        rm -f "$SINGBOX_BINARY"
    fi
    
    # 删除配置目录
    if [[ -d "$CONFIG_DIR" ]]; then
        rm -rf "$CONFIG_DIR"
    fi
    
    # 删除快捷命令
    if [[ -L "/usr/local/bin/sb" ]]; then
        rm -f /usr/local/bin/sb
    fi
    
    echo -e "${GREEN}Sing-box 已完全卸载${NC}"
}
```

## 实施顺序

1. **备份现有文件**：备份 `singbox-install.sh`
2. **添加新函数**：按顺序添加所有新函数
3. **修改主函数**：替换现有主函数逻辑
4. **测试验证**：创建测试脚本验证功能
5. **更新版本号**：更新到 v2.4.5

## 预期效果

1. **避免重复安装**：智能检测已安装状态
2. **用户友好**：提供清晰的选择菜单
3. **功能完整**：支持安装、更新、卸载、诊断
4. **向后兼容**：不破坏现有安装
5. **错误处理**：完善的异常情况处理

## 风险控制

- 所有操作前都有确认提示
- 重要操作自动备份配置
- 详细的状态检查和诊断
- 完整的错误处理机制