# Sing-box 一键搭建脚本开发计划

## 项目概述

开发一个从零构建的轻量化 sing-box 服务器端一键搭建脚本，支持 VLESS Reality Vision、VMess WebSocket 和 Hysteria2 三种协议。

## 详细实施计划

### 阶段一：基础架构搭建

#### 1.1 创建核心脚本文件
- **文件：** `install.sh`
- **功能：** 主安装入口，处理命令行参数，调用各模块
- **原子操作：**
  - 参数解析和验证
  - 系统环境检测
  - 依赖安装检查
  - 模块调用逻辑
- **预期结果：** 可执行的主安装脚本框架

#### 1.2 公共函数库
- **文件：** `scripts/common.sh`
- **功能：** 提供通用工具函数
- **原子操作：**
  - 日志输出函数（info、warn、error）
  - 颜色输出函数
  - 随机字符串生成
  - UUID 生成
  - 端口检测函数
  - 网络连通性检测
- **预期结果：** 完整的工具函数库

#### 1.3 系统检测模块
- **文件：** `scripts/system.sh`
- **功能：** 系统环境检测和基础配置
- **原子操作：**
  - 操作系统类型检测（Ubuntu/Debian/CentOS）
  - 系统版本检测
  - 内存和磁盘空间检查
  - 网络环境检测（IPv4/IPv6）
  - 防火墙状态检测
  - 依赖包安装（curl、wget、unzip 等）
- **预期结果：** 完整的系统环境检测和准备

### 阶段二：协议配置模块

#### 2.1 VLESS Reality Vision 模块
- **文件：** `scripts/protocols/vless.sh`
- **功能：** VLESS Reality 协议配置生成
- **原子操作：**
  - Reality 目标网站选择（默认：addons.mozilla.org）
  - 私钥和公钥生成
  - UUID 生成
  - 端口配置（默认：443）
  - 配置文件片段生成
- **预期结果：** 完整的 VLESS Reality 配置

#### 2.2 VMess WebSocket 模块
- **文件：** `scripts/protocols/vmess.sh`
- **功能：** VMess WebSocket 协议配置生成
- **原子操作：**
  - UUID 生成
  - WebSocket 路径生成
  - 端口配置（默认：80）
  - TLS 证书处理（自签名）
  - 配置文件片段生成
- **预期结果：** 完整的 VMess WebSocket 配置

#### 2.3 Hysteria2 模块
- **文件：** `scripts/protocols/hysteria2.sh`
- **功能：** Hysteria2 协议配置生成
- **原子操作：**
  - 密码生成
  - 端口配置（默认：36712）
  - 自签名证书生成
  - 混淆配置
  - 配置文件片段生成
- **预期结果：** 完整的 Hysteria2 配置

### 阶段三：配置文件生成

#### 3.1 配置模板
- **文件：** `templates/config.json.template`
- **功能：** sing-box 主配置文件模板
- **原子操作：**
  - 基础日志配置
  - 入站规则模板
  - 出站规则配置
  - 路由规则配置
- **预期结果：** 标准的 sing-box 配置模板

#### 3.2 配置生成器
- **文件：** `scripts/config_generator.sh`
- **功能：** 根据用户选择生成最终配置
- **原子操作：**
  - 模板文件读取
  - 协议配置合并
  - 变量替换
  - 配置文件写入
- **预期结果：** 动态生成的 sing-box 配置文件

### 阶段四：服务管理

#### 4.1 systemd 服务配置
- **文件：** `templates/systemd.service`
- **功能：** systemd 服务文件模板
- **原子操作：**
  - 服务启动配置
  - 自动重启配置
  - 用户权限配置
- **预期结果：** 标准的 systemd 服务文件

#### 4.2 服务管理脚本
- **文件：** `scripts/service.sh`
- **功能：** 服务安装、启动、停止管理
- **原子操作：**
  - sing-box 二进制下载和安装
  - systemd 服务注册
  - 服务启动和状态检查
  - 防火墙规则配置
- **预期结果：** 完整的服务管理功能

### 阶段五：客户端配置生成

#### 5.1 客户端配置生成器
- **文件：** `scripts/client.sh`
- **功能：** 生成各种客户端配置格式
- **原子操作：**
  - URL 格式配置生成（vless://、vmess://、hysteria2://）
  - JSON 格式配置生成
  - 二维码生成（可选）
  - Clash 配置生成
- **预期结果：** 多格式客户端配置输出

### 阶段六：用户交互界面

#### 6.1 交互式安装
- **功能：** 用户友好的安装界面
- **原子操作：**
  - 协议选择菜单
  - 参数配置界面
  - 安装进度显示
  - 结果展示
- **预期结果：** 完整的交互式安装体验

#### 6.2 管理命令
- **功能：** 安装后的管理命令
- **原子操作：**
  - 状态查看命令
  - 配置修改命令
  - 服务重启命令
  - 卸载命令
- **预期结果：** 完整的管理命令集

## 技术要点

### 依赖管理
- 自动检测和安装必要依赖
- 支持多种包管理器（apt、yum、dnf）
- 最小化外部依赖

### 安全考虑
- 随机生成所有密钥和密码
- 自动配置防火墙规则
- 证书自动生成和管理

### 兼容性
- 支持主流 Linux 发行版
- 兼容不同架构（x86_64、ARM64）
- 向后兼容性考虑

### 错误处理
- 完整的错误检测和处理
- 详细的错误日志
- 回滚机制

## 开发优先级

1. **高优先级：** 基础架构、系统检测、VLESS Reality 配置
2. **中优先级：** VMess WebSocket、Hysteria2 配置、服务管理
3. **低优先级：** 客户端配置生成、交互界面优化

## 测试计划

- 单元测试：各模块功能测试
- 集成测试：完整安装流程测试
- 兼容性测试：多系统环境测试
- 性能测试：资源占用和连接性能测试

## 预期交付时间

- 阶段一至三：核心功能实现
- 阶段四至五：服务管理和客户端配置
- 阶段六：用户体验优化

总预计开发时间：完整功能实现