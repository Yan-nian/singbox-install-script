# 用户反馈问题修复 - v2.4.7

## 问题概述

用户反馈了三个关键问题：
1. VLESS配置依旧有问题，不可用
2. Linux下sb快捷命令不存在 (`-bash: /usr/local/bin/sb: No such file or directory`)
3. 二维码终端显示太大无法扫描

## 解决方案实施

### 1. VLESS配置修复

**问题分析**: 
- 虽然在v2.4.6中修改了`detect_reality_target`函数，但默认变量仍使用`www.microsoft.com`
- 导致在某些情况下仍使用错误的域名配置

**解决方案**:
- 修改 `lib/protocols.sh` 中的默认变量
- 将 `VLESS_TARGET` 和 `VLESS_SERVER_NAME` 默认值改为 `www.yahoo.com`
- 确保所有情况下都使用正确的域名

**修改内容**:
```bash
# 修改前
VLESS_TARGET="www.microsoft.com:443"
VLESS_SERVER_NAME="www.microsoft.com"

# 修改后
VLESS_TARGET="www.yahoo.com:443"
VLESS_SERVER_NAME="www.yahoo.com"
```

### 2. Linux快捷命令修复

**问题分析**:
- `create_shortcut_command`函数使用了`$SCRIPT_DIR`变量，但该变量可能未正确设置
- 符号链接创建时可能因权限问题失败
- 没有错误处理和用户提示

**解决方案**:
- 使用 `realpath "$0"` 获取脚本的绝对路径
- 添加错误处理，检测符号链接创建是否成功
- 提供手动创建命令的提示
- 确保创建的符号链接具有执行权限

**修改内容**:
```bash
# 确保使用绝对路径
local script_path="$(realpath "$0")"
if ln -sf "$script_path" /usr/local/bin/sb 2>/dev/null; then
    chmod +x /usr/local/bin/sb
    echo -e "${GREEN}Linux 快捷命令已创建: /usr/local/bin/sb${NC}"
else
    echo -e "${YELLOW}警告: 无法创建快捷命令，可能需要管理员权限${NC}"
    echo -e "${YELLOW}手动创建命令: sudo ln -sf \"$script_path\" /usr/local/bin/sb${NC}"
fi
```

### 3. 二维码显示尺寸优化

**问题分析**:
- `qrcode-terminal` 默认生成的二维码尺寸较大
- 在某些终端环境下显示过大，难以扫描

**解决方案**:
- 为所有 `qrcode-terminal` 调用添加 `--small` 参数
- 生成更紧凑的二维码，适合终端显示和扫描

**修改内容**:
```bash
# 修改前
qrcode-terminal "$vless_link"

# 修改后
qrcode-terminal "$vless_link" --small
```

## 技术改进详情

### 路径处理增强

- **问题**: 脚本路径获取不准确
- **解决**: 使用 `realpath` 确保获取绝对路径
- **好处**: 避免相对路径导致的符号链接错误

### 错误处理完善

- **问题**: 符号链接创建失败时没有提示
- **解决**: 添加错误检测和用户友好的提示信息
- **好处**: 用户可以了解问题并手动解决

### 权限管理优化

- **问题**: 创建的符号链接可能没有执行权限
- **解决**: 显式设置执行权限 `chmod +x`
- **好处**: 确保快捷命令可以正常执行

## 版本更新

- 版本号: `v2.4.6` → `v2.4.7`
- 更新文件: `VERSION`

## 修改文件清单

1. **lib/protocols.sh**
   - 修复VLESS默认域名配置
   - 确保使用 `www.yahoo.com` 作为默认目标

2. **lib/subscription.sh**
   - 优化二维码显示尺寸
   - 为所有协议添加 `--small` 参数

3. **singbox-install.sh**
   - 修复Linux快捷命令创建逻辑
   - 增强路径处理和错误处理

4. **VERSION**
   - 版本号更新到 v2.4.7

## 测试建议

### 1. VLESS连接测试
```bash
# 检查配置文件中的域名
grep -i "yahoo" /etc/sing-box/config.json

# 测试连接
ping www.yahoo.com
```

### 2. 快捷命令测试
```bash
# 检查符号链接
ls -la /usr/local/bin/sb

# 测试命令
sb --help
```

### 3. 二维码显示测试
```bash
# 运行脚本并检查二维码尺寸
./singbox-install.sh
# 选择生成二维码选项
```

## 兼容性说明

- **操作系统**: Linux、Windows (WSL/MSYS2/Cygwin)
- **终端**: 支持所有主流终端环境
- **权限**: 自动处理权限问题，提供手动解决方案
- **向后兼容**: 完全兼容现有配置和功能

## 故障排除

### 如果sb命令仍然不可用

1. **检查路径**:
   ```bash
   echo $PATH | grep "/usr/local/bin"
   ```

2. **手动创建符号链接**:
   ```bash
   sudo ln -sf "$(pwd)/singbox-install.sh" /usr/local/bin/sb
   sudo chmod +x /usr/local/bin/sb
   ```

3. **添加到PATH**:
   ```bash
   echo 'export PATH="/usr/local/bin:$PATH"' >> ~/.bashrc
   source ~/.bashrc
   ```

### 如果VLESS仍然无法连接

1. **检查防火墙**:
   ```bash
   sudo ufw allow 443/tcp
   ```

2. **检查服务状态**:
   ```bash
   systemctl status sing-box
   ```

3. **查看日志**:
   ```bash
   journalctl -u sing-box -f
   ```

## 后续优化建议

1. **自动权限检测**: 在脚本开始时检测是否有sudo权限
2. **多域名支持**: 允许用户自定义Reality目标域名
3. **二维码自适应**: 根据终端尺寸自动调整二维码大小
4. **连接测试**: 添加自动连接测试功能
5. **配置验证**: 增强配置文件有效性检查