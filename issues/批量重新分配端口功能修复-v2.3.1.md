# 批量重新分配端口功能修复 - v2.3.1

## 问题描述

用户报告批量重新分配端口功能无法正常工作，经过调试发现以下问题：

1. **缺少配置管理函数**: `lib/menu.sh` 中的 `reassign_all_ports()` 和 `change_single_port()` 函数调用了不存在的 `load_config()` 和 `save_config()` 函数
2. **generate_config 函数调用错误**: 调用 `generate_config()` 时没有传递必需的协议参数
3. **缺少 jq 依赖**: 配置管理需要 jq 工具来解析和修改 JSON 配置文件

## 解决方案

### 1. 创建配置管理模块

**文件**: `lib/config_manager.sh`

- 实现 `load_config()` 函数：从 JSON 配置文件中提取端口信息
- 实现 `save_config()` 函数：更新 JSON 配置文件中的端口配置
- 实现 `show_current_config()` 函数：显示当前配置信息
- 实现 `init_config_vars()` 函数：初始化配置变量

**核心功能**:
- 使用 jq 工具解析和修改 JSON 配置
- 自动备份原配置文件
- 支持 VLESS、VMess、Hysteria2 三种协议的端口管理
- 配置文件验证和错误恢复

### 2. 修改主安装脚本

**文件**: `singbox-install.sh`

- 在 `load_modules()` 函数中添加配置管理模块的加载
- 在依赖安装中添加 jq 包
- 更新版本号到 v2.3.1

### 3. 修复菜单模块

**文件**: `lib/menu.sh`

- 修复 `reassign_all_ports()` 函数中的 `generate_config()` 调用
- 修复 `change_single_port()` 函数中的 `generate_config()` 调用
- 添加协议检测逻辑，确保只为已配置的协议生成配置

### 4. 创建测试脚本

**文件**: `test_port_reassign.sh`

- 验证配置管理模块的加载
- 测试配置文件的读取和写入
- 验证端口重新分配功能
- 提供完整的功能测试流程

## 技术细节

### 配置文件结构

配置管理模块支持以下 JSON 结构：

```json
{
  "inbounds": [
    {
      "type": "vless",
      "listen_port": 8443,
      "users": [{
        "uuid": "..."
      }]
    },
    {
      "type": "vmess",
      "listen_port": 8080,
      "users": [{
        "uuid": "..."
      }]
    },
    {
      "type": "hysteria2",
      "listen_port": 9443,
      "users": [{
        "password": "..."
      }]
    }
  ]
}
```

### 端口分配逻辑

1. **加载当前配置**: 从 JSON 文件中提取现有端口
2. **生成新端口**: 为每个已配置的协议生成随机端口（10000-65535）
3. **更新配置**: 使用 jq 更新 JSON 文件中的端口值
4. **验证配置**: 确保 JSON 格式正确
5. **重新生成**: 调用 `generate_config()` 重新生成完整配置
6. **重启服务**: 如果服务正在运行，则重启以应用新配置

### 错误处理

- **配置文件备份**: 每次修改前自动创建备份
- **JSON 验证**: 修改后验证配置文件格式
- **回滚机制**: 验证失败时自动恢复备份
- **依赖检查**: 确保 jq 工具可用

## 测试验证

### 手动测试

1. 运行测试脚本：
   ```bash
   chmod +x test_port_reassign.sh
   sudo ./test_port_reassign.sh
   ```

2. 通过主菜单测试：
   ```bash
   sudo ./singbox-install.sh
   # 选择端口管理 -> 批量重新分配端口
   ```

### 预期结果

- 配置管理模块正常加载
- 能够从 JSON 配置文件中读取端口信息
- 能够生成新的随机端口
- 能够更新 JSON 配置文件
- 配置文件格式保持正确
- 服务能够正常重启（如果适用）

## 兼容性

- **操作系统**: Ubuntu, Debian, CentOS, RHEL, Fedora
- **依赖要求**: jq, systemctl, curl, wget
- **Sing-box 版本**: 支持所有使用 JSON 配置的版本

## 版本更新

- **版本**: v2.3.0 → v2.3.1
- **更新日期**: 2024-12-19
- **更新类型**: Bug 修复

## 相关文件

- `lib/config_manager.sh` - 新增配置管理模块
- `singbox-install.sh` - 修改主安装脚本
- `lib/menu.sh` - 修复菜单模块
- `test_port_reassign.sh` - 新增测试脚本
- `issues/批量重新分配端口功能修复-v2.3.1.md` - 本文档

## 后续优化建议

1. **配置缓存**: 考虑添加配置缓存机制以提高性能
2. **端口冲突检测**: 增强端口冲突检测和解决机制
3. **配置验证**: 添加更详细的配置文件验证
4. **日志记录**: 增强配置修改的日志记录
5. **回滚功能**: 提供配置回滚到指定版本的功能